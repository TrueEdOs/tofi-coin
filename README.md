# Toficoin

Тофикоин - криптовалюта, использующая механизм PoW (Proof-of-work) соревновательного типа на основе игры в Tetris для подтверждения транзакций перевода средств между пользователями.

У каждого пользователя существует пара ключей (открытый и закрытый) для ECDSA подписи транзакций, а также адрес - SHA-256(прим. здесь и далее SHA-256 обозначает двойной SHA-256 хэш) хэш от публичного ключа пользователя.

Блокчейн криптовалюты представляет из себя цепочку блоков, связанных хэш-значениями информации из предыдущих блоков, подтвержденных последовательностью ходов игры в тетрис, фигурки которого генерируются из хэш-функции от содержимого блока.

## Структура блока
Блоки делятся на два типа: Light и Heavy. Heavy блок содержит в себе Light блок, а также информацию о балансе счетов всех пользователей сети.
Строение блока можно описать следующей схемой: Block header || Tetris solution || Transactions || Balances (в Light блоке отсутсвует).

### Block header
Структура header'а блоков:
| Name | Size |
|:----: | :---- |
| 4 bytes | Block number |
| 32 bytes | Prev block hash |
| 32 bytes | Merkle root of transactions |
| 32 bytes | Merkle root of balances | 
| 4 bytes | Timestamp |
| 32 bytes | Adress of solver |
| 4 bytes | Score |

### Transaction
Структура транзакции:
| Name | Size |
|:----: | :---- |
| 32 bytes | Adress of sender |
| 32 bytes | Adress of receiver |
| 8 bytes | Amount of currency sended |
| 8 bytes | Fee for block miner |
| 33 bytes | Public key of sender |
| 64bytes | ECDSA signature of SHA-256 of transaction|

Дерево Меркла строится операцией конкатенации строк хэшей потомков вершины.

### Balances
Структура поля balances:
| Name | Size |
|:----: | :---- |
| 8 bytes | Number of adresses |
|32 bytes | Adress_1 |
|8 bytes | Balance of adress_1 |
| ...Number | of adresses |

## Tetris generation and solution
Задача всех майнеров состоит в следующем: по известному ограниченному набору фигурок Тетриса необходимо набрать нужное количество очков (goal) в этой игре быстрее всех остальных.
Генерация фигурок производится посредством установки SHA-256 хэша от заголовка блока, который майнер пытается закрыть (без поля score) в качестве seed'а генератора псевдослучайных чисел, известного всем участникам сети.
После этого майнер пытается набрать число очков более или равное, чем goal, использовав только 1.000.000 фигурок тетриса. Чтобы уравнять шансы майнеров в сети относительно их вычислительной мощности, и для гарантии закрытия блока, goal постепенно снижается до 0, с использованием функции *function_name* от времени, прошедшего с момента закрытия прошлого блока.
При нахождения решения этой задачи, майнер генерирует последовательность координат фигурок в момент конца их движения, и записывает ее в блок для валидации другими майнерами.

### Tetris solution
Структура поля Tetris solution:
| Name | Size |
|:----: | :---- |
| 4 bytes | Number of figures |
| 2 bits | Figure_1 rotation |
| 4 bits | Figure_1 final X-axis |
| 6 bits | Figure_1 final Y-axis | 
| ...Number | of figures |

## Достижение консенсуса сети
### Разрешение конфликтных цепочек
Все майнеры сами для себя решает, какой блок ему включать в свой блокчейн, а какой - нет. В общем случае при возникновении конфликта закрытых блоков им стоит пользоваться принципом __GHOST__ _by Sompolinsky and Zohar_. А именно из нескольких возможных цепочек блоков выбирать ту, сумма счетов в блоках в которой максимальна. Это гарантирует достижение консенсуса сети за конечное время, и защиту от атаки __51%__.
### Создание нового майнера
Для получения правильного последнего блока, и актуальных балансов участников сети, новому майнеру следует скачать несколько последних Light блоков сети, а также Heavy версию последнего блока и сверить совпадение корней Меркла балансов этих блоков.




